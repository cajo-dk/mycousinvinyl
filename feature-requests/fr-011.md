# Feature Request

- REQUEST ID: FR-011
- DATE: 2026.01.08

## Abstract

Add automated Postgres database backups on configurable weekdays and times (15-minute increments), storing the backup on an external data drive and uploading it to a SharePoint folder in the same Azure tenant. After upload success or failure, the local backup file is removed. All outcomes must be logged.

## Scope

- Backend/ops: scheduled backup job and configuration.
- Storage: external data drive mounted into the container.
- Integration: SharePoint upload using the same Azure tenant as authentication.
- Home Assistant add-on: configuration surfaced in the add-on UI.

## Requirements

### Scheduling

- Backups run on specific weekdays at a specified time, in 15-minute increments (e.g., 00, 15, 30, 45).
- Schedule must be configurable without code changes (env/config).
- If the scheduled time is missed, the job should wait until the next scheduled interval (no backfill runs).
- The backup job executes from the Home Assistant application container.

### Backup Creation

- Create a logical Postgres SQL dump (`.sql`) that is restorable.
- Backup is written only to the external data drive path (no container-local storage).
- The job must fail fast with a logged error if the external drive path is missing or not writable.

### External Drive Mount (Home Assistant)

- Document how to attach and mount an external data drive for the add-on container.
- The mount path must align with `BACKUP_EXTERNAL_PATH`.
- The add-on must not attempt to write backups outside the mounted external path.

### SharePoint Upload

- Upload the backup file to a configured SharePoint folder in the same Azure tenant used for auth.
- Authentication for SharePoint must use tenant-approved credentials (service principal or managed identity).
- Upload success and failure must be detectable for logging and cleanup.

### Cleanup

- After upload success, remove the local backup file from the external data drive.
- After upload failure, remove the local backup file as well.
- Cleanup failures must be logged but should not mask the backup/upload result.

### Logging

- Log success and failure to the system log with:
  - user = `*system`
  - component = `Backup`
  - backup filename
  - size (if available)
  - duration
  - failure details (error message/stack, if applicable)

## Configuration

- `BACKUP_SCHEDULE_DAYS`: list of weekdays (Mon-Sun).
- `BACKUP_SCHEDULE_TIME`: 24h time, 15-minute increments (HH:mm).
- `BACKUP_EXTERNAL_PATH`: mounted external data drive path.
- `BACKUP_SHAREPOINT_SITE`, `BACKUP_SHAREPOINT_LIBRARY`, `BACKUP_SHAREPOINT_FOLDER`: target upload location.
- `BACKUP_SHAREPOINT_TENANT_ID`, `BACKUP_SHAREPOINT_CLIENT_ID`, `BACKUP_SHAREPOINT_CLIENT_SECRET` (or managed identity settings).
- `BACKUP_TIMEZONE`: optional; defaults to server local time if not set.

### Home Assistant Add-on Configuration

- The backup schedule (days + time) must be configurable from the add-on Configuration tab.
- The add-on config UI must expose the external backup path.
- Configuration values map to the environment/config inputs above.

## Acceptance Criteria

- A backup file is created only on the external data drive at the configured schedule.
- The backup uploads to the configured SharePoint folder under the same tenant.
- The local backup file is removed after upload success or failure.
- Success and failure outcomes are logged with required metadata.
- Missing or unwritable external path results in a logged failure and no upload attempt.
- Home Assistant add-on configuration allows setting the backup schedule without code changes.
